name: Benchmark

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:

jobs:
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Start server
        run: |
          node dist/server.js &
          echo "Waiting for server to start..."
          sleep 5
          curl -s http://localhost:3000/health || exit 1
          echo "Server is ready"

      - name: Run benchmark
        run: |
          npx autocannon -c 50 -d 10 -j http://localhost:3000/health > benchmark-result.json

      - name: Generate report
        run: |
          echo "## ğŸš€ Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Requests/sec | $(jq '.requests.average' benchmark-result.json) |" >> $GITHUB_STEP_SUMMARY
          echo "| Latency avg | $(jq '.latency.average' benchmark-result.json)ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Latency p50 | $(jq '.latency.p50' benchmark-result.json)ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Latency p99 | $(jq '.latency.p99' benchmark-result.json)ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Throughput | $(jq '.throughput.average' benchmark-result.json) bytes/sec |" >> $GITHUB_STEP_SUMMARY

      - name: Check performance threshold
        run: |
          RPS=$(jq '.requests.average' benchmark-result.json)
          P99=$(jq '.latency.p99' benchmark-result.json)
          echo "RPS: $RPS, P99: ${P99}ms"

          # RPS é˜ˆå€¼æ£€æŸ¥ (GitHub Actions runner æ€§èƒ½è¾ƒä½ï¼Œé˜ˆå€¼è®¾ä¸º 2000)
          if (( $(echo "$RPS < 2000" | bc -l) )); then
            echo "âŒ Performance regression: RPS ($RPS) below threshold (2000)"
            exit 1
          fi

          # P99 å»¶è¿Ÿæ£€æŸ¥ (CI ç¯å¢ƒå»¶è¿Ÿè¾ƒé«˜ï¼Œé˜ˆå€¼è®¾ä¸º 150ms)
          if (( $(echo "$P99 > 150" | bc -l) )); then
            echo "âš ï¸ Warning: P99 latency (${P99}ms) exceeds 150ms"
          fi

          echo "âœ… Performance check passed!"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-result.json
          retention-days: 30
