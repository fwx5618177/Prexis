name: Deploy

on:
  # Build å®ŒæˆåŽè‡ªåŠ¨è§¦å‘
  repository_dispatch:
    types: [deploy]
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        type: choice
        options:
          - test
          - pre
          - prod
      image:
        description: 'é•œåƒåœ°å€ (å¦‚ ghcr.io/owner/repo:v1.0.0)'
        required: true

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || github.event.client_payload.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || github.event.client_payload.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "image=${{ github.event.inputs.image }}" >> $GITHUB_OUTPUT
          else
            echo "environment=${{ github.event.client_payload.environment }}" >> $GITHUB_OUTPUT
            echo "image=${{ github.event.client_payload.image }}" >> $GITHUB_OUTPUT
          fi

      - name: Create .env file
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: Deploy
        run: |
          echo "ðŸš€ Deploying to ${{ steps.vars.outputs.environment }}"
          echo "Image: ${{ steps.vars.outputs.image }}"
          #
          # SSH éƒ¨ç½²:
          # ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          #   "docker pull ${{ steps.vars.outputs.image }} && \
          #    cd /app && docker compose up -d"
          #
          # Kubernetes:
          # kubectl set image deployment/prexis prexis=${{ steps.vars.outputs.image }}
